#!/bin/bash
BN=$(basename "$0")
DN=$(dirname "$0")
. "${DN}/sh/common"
#--------------------------------------------------------------

usage() {
  cat <<EOT
  usage: $0 <package-shortname> [backend-project-name]
EOT
  exit 1
}

PACKAGE_SHORTNAME=$1
BACKEND_PROJECT_NAME=$2
[ -n "${PACKAGE_SHORTNAME}" ] || usage

PACKAGE_DIR="ng/apps"
PACKAGE_JSON="${WORKSPACE_DIR}/projects/${PACKAGE_DIR}/${PACKAGE_SHORTNAME}/package.json"

CMD=( npx nx generate @nrwl/angular:application  "${PACKAGE_SHORTNAME}" --name="${PACKAGE_SHORTNAME}" --directory="${PACKAGE_DIR}" --simpleModuleName=true --style=scss --routing=true --prefix=hot --strict )
[ -z "${BACKEND_PROJECT_NAME}" ] || CMD+=( --backendProject="${BACKEND_PROJECT_NAME}" )

echo "${CMD[@]}"
"${CMD[@]}" || die "failed"

cat >"${PACKAGE_JSON}" <<EOT
{
  "name": "@homeofthings/${PACKAGE_SHORTNAME}",
  "description": "HomeOfThings - ${PACKAGE_SHORTNAME}",
  "version": "0.0.1"
}
EOT
[ $? -eq 0 ] || die "failed to create '${PACKAGE_JSON}'"

"${DN}/project.ts" rename "ng-apps-${PACKAGE_SHORTNAME}" "${PACKAGE_SHORTNAME}" || exit 1
"${DN}/project.ts" rename "ng/apps-${PACKAGE_SHORTNAME}-e2e" "${PACKAGE_SHORTNAME}-e2e" || exit 1

succeeded
